<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Claude Terminal</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #1e1e2e;
        }
        #terminal {
            height: 100%;
            width: 100%;
        }
        #scroll-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(137, 180, 250, 0.9);
            color: #1e1e2e;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            display: none;
            z-index: 1000;
        }
        #scroll-indicator.visible {
            display: block;
        }
        .xterm-viewport::-webkit-scrollbar {
            width: 8px;
        }
        .xterm-viewport::-webkit-scrollbar-track {
            background: #1e1e2e;
        }
        .xterm-viewport::-webkit-scrollbar-thumb {
            background: #45475a;
            border-radius: 4px;
        }
        .xterm-viewport::-webkit-scrollbar-thumb:hover {
            background: #585b70;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
</head>
<body>
    <div id="terminal"></div>
    <div id="scroll-indicator">â†“ New output (PgDn or Ctrl+End)</div>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
    <script>
        (function() {
            const terminal = new Terminal({
                fontSize: 14,
                fontFamily: '"Fira Code", "JetBrains Mono", "Cascadia Code", Menlo, Monaco, "Courier New", monospace',
                cursorBlink: true,
                cursorStyle: 'bar',
                scrollback: 50000,
                scrollOnUserInput: false,  // TMUX-like: don't auto-scroll on input
                theme: {
                    background: '#1e1e2e',
                    foreground: '#cdd6f4',
                    cursor: '#f5e0dc',
                    cursorAccent: '#1e1e2e',
                    selection: '#45475a',
                    black: '#45475a',
                    red: '#f38ba8',
                    green: '#a6e3a1',
                    yellow: '#f9e2af',
                    blue: '#89b4fa',
                    magenta: '#f5c2e7',
                    cyan: '#94e2d5',
                    white: '#bac2de',
                    brightBlack: '#585b70',
                    brightRed: '#f38ba8',
                    brightGreen: '#a6e3a1',
                    brightYellow: '#f9e2af',
                    brightBlue: '#89b4fa',
                    brightMagenta: '#f5c2e7',
                    brightCyan: '#94e2d5',
                    brightWhite: '#a6adc8'
                }
            });

            const fitAddon = new FitAddon.FitAddon();
            const webLinksAddon = new WebLinksAddon.WebLinksAddon();
            const indicator = document.getElementById('scroll-indicator');

            terminal.loadAddon(fitAddon);
            terminal.loadAddon(webLinksAddon);
            terminal.open(document.getElementById('terminal'));
            fitAddon.fit();

            // === TMUX-LIKE SCROLL MODE ===
            // NO auto-scroll - user controls everything with PageUp/Down

            let hasNewOutput = false;

            // Check if at bottom
            function isAtBottom() {
                const viewport = document.querySelector('.xterm-viewport');
                if (!viewport) return true;
                return viewport.scrollTop + viewport.clientHeight >= viewport.scrollHeight - 50;
            }

            // Show/hide new output indicator
            function updateIndicator() {
                if (hasNewOutput && !isAtBottom()) {
                    indicator.classList.add('visible');
                } else {
                    indicator.classList.remove('visible');
                    hasNewOutput = false;
                }
            }

            // Track scroll position
            const viewport = document.querySelector('.xterm-viewport');
            if (viewport) {
                viewport.addEventListener('scroll', updateIndicator);
            }

            // WebSocket connection
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = protocol + '//' + location.host + '/ws';
            const socket = new WebSocket(wsUrl);

            socket.binaryType = 'arraybuffer';

            socket.onopen = function() {
                console.log('WebSocket connected');
            };

            socket.onmessage = function(event) {
                const data = new Uint8Array(event.data);
                terminal.write(data);

                // Mark that there's new output if not at bottom
                if (!isAtBottom()) {
                    hasNewOutput = true;
                    updateIndicator();
                }
            };

            socket.onclose = function() {
                terminal.write('\r\n\x1b[31mConnection closed. Refresh to reconnect.\x1b[0m\r\n');
            };

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };

            // Send terminal input to server
            terminal.onData(function(data) {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(new TextEncoder().encode(data));
                }
            });

            // Handle window resize
            window.addEventListener('resize', function() {
                fitAddon.fit();
                const dims = fitAddon.proposeDimensions();
                if (dims && socket.readyState === WebSocket.OPEN) {
                    const resizeMsg = JSON.stringify({cols: dims.cols, rows: dims.rows});
                    socket.send(new TextEncoder().encode('\x01' + resizeMsg));
                }
            });

            // === KEYBOARD NAVIGATION (tmux-like) ===
            document.addEventListener('keydown', function(e) {
                const scrollAmount = terminal.rows - 2;

                if (e.key === 'PageUp') {
                    e.preventDefault();
                    terminal.scrollLines(-scrollAmount);
                }
                else if (e.key === 'PageDown') {
                    e.preventDefault();
                    terminal.scrollLines(scrollAmount);
                    updateIndicator();
                }
                else if (e.key === 'End' && e.ctrlKey) {
                    // Ctrl+End = jump to bottom (like tmux prefix + End)
                    e.preventDefault();
                    terminal.scrollToBottom();
                    hasNewOutput = false;
                    updateIndicator();
                }
                else if (e.key === 'Home' && e.ctrlKey) {
                    // Ctrl+Home = jump to top
                    e.preventDefault();
                    terminal.scrollToTop();
                }
                // Arrow keys for fine scrolling
                else if (e.key === 'ArrowUp' && e.shiftKey) {
                    e.preventDefault();
                    terminal.scrollLines(-1);
                }
                else if (e.key === 'ArrowDown' && e.shiftKey) {
                    e.preventDefault();
                    terminal.scrollLines(1);
                    updateIndicator();
                }
            });

            // Mouse wheel scrolling (natural)
            document.addEventListener('wheel', function(e) {
                // Let xterm handle normal scroll
                // Shift+wheel for faster scroll
                if (e.shiftKey) {
                    e.preventDefault();
                    const amount = e.deltaY > 0 ? 10 : -10;
                    terminal.scrollLines(amount);
                    updateIndicator();
                }
            }, { passive: false });

            // Click on indicator to scroll to bottom
            indicator.addEventListener('click', function() {
                terminal.scrollToBottom();
                hasNewOutput = false;
                updateIndicator();
            });

            // Initial fit
            setTimeout(() => fitAddon.fit(), 100);
        })();
    </script>
</body>
</html>
